




.PN 1
.FO                                3-#
3. Design and Implementation of an IOP

     Aî IOĞ ió laiä ouô iî á manneò similaò tï á BIOS®   Alì IOPó 
are divided into two parts:
.uj 0

          1. a jump table at the front
          2. a set of supporting routines after the jump table
.uj 1

     Alì  routineó  iî  aî  IOĞ arå defineä  iî  termó  oæ  theiò 
function¬  inpuô parameters¬ outpuô parameters¬ anä sidå effects®  
This chapter serves to document all routines within an IOP.


3.1. IOP Jump Table

     Thå jumğ tablå oæ aî IOĞ ió organizeä aó follows:
.uj 0

     Section   Offset    Mnemonic  Description of Routine
               Hex Dec

     IOP        00   0   STATUS    IOP Status Reporting
     Status     03   3   SELECT    IOP Device Selection
     and        06   6   NAMER     IOP Device Name Reporting
     Control    09   9   INIT      IOP Initialization

                0C  12   CONST     Console Input Status
                0F  15   CONIN     Console Input Character
                12  18   CONOUT    Console Output Character
     BIOS       15  21   LIST      List Output Character
     Interface  18  24   PUNCH     Punch Output Character
                1B  27   READER    Reader Input Character
                1E  30   LISTST    List Output Status

     IOP Patch  21  33   PATCH     Patch Console

                24  36   COPEN     Open Console Recorder
     IOP        27  39   CCLOSE    Close Console Recorder
     Recorder   2A  42   LOPEN     Open List Recorder
                2D  45   LCLOSE    Close List Recorder

     IOP ID     30  48   ID        IOP ID (5 bytes = Z3IOP)

               FIGURE: Jump Table and ID of an IOP
.uj 1


     Thå  IOĞ Statuó anä Controì routineó arå useä tï  initializå 
thå  IOP¬  determinå  thå typå oæ thå IOP¬  obtaiî nameó  oæ  anä 
commentó oî deviceó containeä withiî thå IOP¬  anä selecô deviceó 
withiî  thå  IOP®   Thå  ZCPR³ DEÖ anä  DEVICÅ  utilitù  commandó 
perforí alì oæ theiò functionó througè theså fouò routines.
.cp 3Š     Thå BIOÓ Interfacå routineó iî thå IOĞ arå thå samå aó theiò 
counterpartó  iî thå BIOS®   Thå BIOÓ simplù indexeó intï thå IOĞ 
aô theså routineó (seå thå lasô chapter).
     Thå IOĞ Patcè routinå ió useä tï makå temporarù changeó tï á 
particulaò  consolå selection®   Iô allowó thå calleò tï  providå 
hió  owî  driveró foò á particulaò consolå anä havå thå IOĞ  calì 
theså wheî thió consolå ió selected.
     Thå  IOĞ  Recordeò provideó foò thå facilitù oæ sendinç  alì 
outpuô  intendeä foò á consolå oò lisô devicå tï á disë filå  anä 
remotå  computeò aó well®   Thå RECORÄ utilitù commanä  oæ  ZCPR³ 
controló thió function.
     Thå IOĞ IÄ ió useä tï identifù thå IOĞ Systeí Segmenô tï thå 
LDÒ  commanä oæ ZCPR3®   LDÒ wilì refuså tï loaä aî IOĞ intï  thå 
IOĞ  Buffeò iæ thió IÄ ió noô present®   Thå IÄ consistó  oæ  thå 
five bytes 'Z3IOP'.
     Iî  alì  cases¬  thå  programmeò  musô assumå  thaô  (1©  nï 
registeró  arå preserveä bù callinç routineó iî aî IOP¬  (2©  thå 
inpuô anä outpuô parameteò conventionó presenteä iî thió documenô 
arå adhereä to¬  anä (3© anù registeò noô specifieä iî aî  outpuô 
parameteò  lisô maù bå changeä froí itó valuå beforå thå calì  tï 
thå IOĞ routine.

3.2. IOP Status and Control Routines

     Thió  sectioî  describeó thå Statuó anä Controì Routineó  oæ 
the IOP.  These routines are:
.uj 0

     Section   Offset    Mnemonic  Description of Routine
               Hex Dec

     IOP        00   0   STATUS    IOP Status Reporting
     Status     03   3   SELECT    IOP Device Selection
     and        06   6   NAMER     IOP Device Name Reporting
     Control    09   9   INIT      IOP Initialization
.uj 1

3.2.1. STATUS

Brief Description:
     STATUÓ returnó informatioî oî thå fouò logicaì deviceó (CON¬ 
RDR¬  PUN¬ anä LST© supporteä bù thå IOĞ anä thå statuó oæ thå IÏ 
Recordeò  functioî oæ thå IOP®   Aî identifyinç numbeò oæ thå IOĞ 
ió alsï returned.

Discussion and Notes:
     Thå IOĞ concepô supportó fouò logicaì devices¬  aó á normal¬ 
unmodifieä BIOÓ does®   Associateä witè eacè logicaì devicå ió  á 
bytå  paiò whicè indicateó ho÷ manù devicå driveró arå  availablå 
foò  thå  logicaì  devicå anä whicè devicå  driveò  ió  currentlù 
selected®  Thió informatioî ió storeä iî á tablå aó follows:
.uj 0

     IOPTABLE:
          CON:      db   count,assignment
          RDR:      db   count,assignment
          PUN:      db   count,assignment
          LST:      db   count,assignment
.uj 1
.cp 2Š     Iî eacè case¬  "count¢ ió thå numbeò oæ devicå driveró (° tï 
255© availablå foò thå indicateä logicaì device¬ anä "assignment¢ 
ió  thå  numbeò  (°  tï count-1© oæ thå devicå  driveò  whicè  ió 
currentlù assigned.
     STATUÓ  returnó thå baså addresó (IOPTABLE© oæ thió tablå iî 
thå HÌ registeò pair.
.cp 4
     STATUÓ alsï returnó witè registeò A=° anä thå Zerï Flaç  Seô 
iæ  therå ió nï I/Ï devicå supporô iî thå IOP®   Iæ therå ió  I/Ï 
devicå  support¬  thå  Zerï  Flaç  ió cleareä (NZ© anä  Á  ió  aî 
indicatoò aó follows:
.uj 0

          MSB of A = 0        means     IO Recorder not available
          MSB of A = 1        means     IO Recorder available
          7 LSBs of A         mean      IOP Number (1..127)
.uj 1

     Iæ thå IÏ Recordeò routineó arå active¬ thå mosô significanô 
biô  (MSB©  oæ registeò Á ió set®   Eacè IOĞ musô havå  á  numbeò 
(selecteä bù thå implementer)¬  anä thió ió storeä iî thå · leasô 
significanô  bitó (LSBs© oæ registeò A®   Thió numbeò ió noô useä 
bù  DEV¬  DEVICE¬  oò RECORDER¬  anä ió oæ interesô onlù  tï  thå 
implementeò tï tracë hió variouó IOPs.
.uj 0

Input Parameters: None
Output Parameters:
     HL = Address of IOP Status Table
     A  = Flag
          A=0 and Zero Flag Set (Z) if no I/O device support
          A<>0 if I/O device support --
            MSB of register A indicates if IO Recorder available
            other bits of register A indicate IOP number
.uj 1

3.2.2. SELECT

Brief Description:
     SELECÔ  ió useä tï selecô á particulaò IOĞ devicå driveò  tï 
bå useä foò á giveî logicaì device.

Discussion and Notes:
     Inpuô parameteró arå passeä iî thå BÃ registeò pair.
     Registeò Â ió thå logicaì devicå number¬  wherå COÎ ½ 0¬ RDÒ 
½ 1¬  PUÎ ½ 2¬  anä LSÔ ½ 3®  Anù valuå greateò thaî ³ resultó iî 
nï devicå selectioî anä aî erroò code.
     Registeò Ã ió thå numbeò oæ aî IOĞ devicå driveò tï  select®  
Registeò Ã maù takå oî anù valuå froí ° tï count-1¬ wherå 'count§ 
ió  thå numbeò oæ devicå driveró availablå foò thå giveî  logicaì 
device®  Thå STATUÓ routinå caî bå useä tï determinå thå valuå oæ 
'count'.
     On exit, register A is an error code.
.uj 0

Input Parameters:
     B = number of logical device
          CON = 0        RDR = 1
          PUN = 2        LST = 3
     C = number of device driver (0 to count-1, where count is
          determined from the STATUS routine)
.cp 4ŠOutput Parameters:
     A=0 and Zero Flag Set (Z) if device selection error
          (no device selected)
     A=0FFH and NZ if selection made
.uj 1

3.2.3. NAMER

Brief Description:
     NAMEÒ  returnó  thå addresó oæ á strinç (sequencå  oæ  byteó 
terminateä  bù  á null¬  oò binarù 0© whicè  describeó  á  devicå 
driver®  Thió strinç maù takå onå oæ twï forms:
.uj 0

   dâ   'NAME ',°                     ;devicå namå only¬ alì caps
or dâ   'NAMÅ textuaì description',°  ;namå witè description

     NAME must be followed by at least one space.
.uj 1

Discussion and Notes:
     NAMEÒ  returnó  á  strinç containinç thå namå  anä  optionaì 
descriptioî  oæ á devicå driver®   Thå driveò ió referenceä bù  á 
logicaì  devicå numbeò passeä iî registeò Â anä á  devicå  driveò 
numbeò  passeä  iî registeò Ã (samå conventioî aó foò thå  SELECÔ 
routine).
     Thå  strinç  MUSÔ consisô oæ aô leasô á namå followeä  bù  á 
space®   Anù  texô followinç thió spacå ió takeî aó á commenô  bù 
thå DEÖ anä DEVICÅ commands.
     Registeò Â ió thå logicaì devicå number¬  wherå COÎ ½ 0¬ RDÒ 
½ 1¬  PUÎ ½ 2¬  anä LSÔ ½ 3®  Anù valuå greateò thaî ³ resultó iî 
nï devicå selectioî anä aî erroò code.
     Registeò Ã ió thå numbeò oæ aî IOĞ devicå driveò tï  providå 
thå namå for®   Registeò Ã maù takå oî anù valuå froí ° tï count-
1¬  wherå  'count§ ió thå numbeò oæ devicå driveró availablå  foò 
thå  giveî  logicaì device®   Thå STATUÓ routinå caî bå  useä  tï 
determinå thå valuå oæ 'count'.
.uj 0

Input Parameters:
     B = number of logical device
          CON = 0        RDR = 1
          PUN = 2        LST = 3
     C = number of device driver (0 to count-1, where count is
          determined from the STATUS routine)

Output Parameters:
     HL = address of first character of a null-terminated
          string which is structured in one of two ways:

               dâ   'NAME ',°
or             dâ   'NAMÅ textuaì description',°

     A=Error code
          A=0 and Zero Flag Set (Z) if device selection error
               (B > 3 or C > count-1)
          A=0FFH and NZ if valid device name string returned
.uj 1
.paŠ3.2.4. INIT

Brief Description:
     INIT initializes the devices controlled by the IOP.

Discussion and Notes:
     INIÔ  maù perforí anù initializationó required®   Theså  maù 
include:
.uj 0

          1® UART/USARÔ communicationó attributeó (numbeò oæ bitó 
               tï transmit¬ parity¬ etc)
          2® bauä rates
          3® IÏ Recordeò statå (recommendeä tï bå seô tï OFÆ foò 
               botè consolå anä lisô recording)
          4® thå initiaì assignmenô oæ thå devicå driveró foò 
               eacè logicaì device

Input Parameters: None
Output Parameters: None

3.3. BIOS Interface Routines

     This section describes the BIOS Interface routines:

     Section   Offset    Mnemonic  Description of Routine
               Hex Dec

                0C  12   CONST     Console Input Status
                0F  15   CONIN     Console Input Character
                12  18   CONOUT    Console Output Character
     BIOS       15  21   LIST      List Output Character
     Interface  18  24   PUNCH     Punch Output Character
                1B  27   READER    Reader Input Character
                1E  30   LISTST    List Output Status
.uj 1

     Alì  oæ  theså routineó supporô thå samå  inpuô  anä  outpuô 
parameteró aó thå BIOS®

3.3.1. CONST

Brief Description:
     CONSÔ  returnó  thå  inpuô characteò statuó oæ  thå  logicaì 
console (CON) device.

Discussion and Notes:
     Registeò A=0FFÈ iæ á characteò ió availablå froí thå consolå 
device®  Registeò A=° iæ nï characteò ió available.
     Dï noô assumå thaô thå zerï flaç ió seô oò reset®  Thå valuå 
of the A register is the only output parameter.

Input Parameters: None
Output Parameters:
     A=0FFÈ iæ characteò pending¬ A=° iæ nï characteò pending
.cp 5Š3.3.2. CONIN

Brief Description:
     CONIÎ  returnó thå nexô bytå froí thå console®   Iæ nonå  ió 
availablå  aô thå timå CONIÎ ió called¬  CONIÎ wilì waiô untiì  á 
bytå becomeó available.

Discussion and Notes:
     Dependinç  oî thå IOĞ devicå driveò selection¬  CONIÎ maù oò 
maù noô cleaò (seô tï zero© thå MSÂ oæ thå characteò returned.

Input Parameters: None
Output Parameters:
     A = next byte available from the console

3.3.3. CONOUT

Brief Description:
     CONOUT outputs the byte in register C to the console.

Discussion and Notes:
     Dependinç oî thå selecteä devicå driver¬ thå MSÂ oæ thå bytå 
may or may not be cleared.

Input Parameters:
     C = byte to output to the console
Output Parameters: None

3.3.4. LIST

Brief Description:
     LIST outputs the byte in register C to the list device.

Discussion and Notes:
     Dependinç oî thå selecteä devicå driver¬ thå MSÂ oæ thå bytå 
may or may not be cleared.

Input Parameters:
     C = byte to output to the list device
Output Parameters: None

3.3.5. PUNCH

Brief Description:
     PUNCH outputs the byte in register C to the punch device.

Discussion and Notes:
     Dependinç oî thå selecteä devicå driver¬ thå MSÂ oæ thå bytå 
may or may not be cleared (set to zero).

Input Parameters:
     C = byte to output to the punch device
Output Parameters: None
.paŠ3.3.6. READER

Brief Description:
     READER returns the next byte from the reader device.

Discussion and Notes:
     Dependinç oî thå IOĞ devicå driveò selection¬  READEÒ maù oò 
maù noô cleaò (set to zero) thå MSÂ oæ thå characteò returned.

Input Parameters: None
Output Parameters:
     A = next byte available from the reader

3.3.7. LISTST

Brief Description:
     LISTSÔ  returnó  thå  outpuô  statuó  oæ  thå  lisô  device®  
Registeò  A=0FFÈ  meanó thaô thå lisô devicå ió  readù  tï  outpuô 
anotheò byte®   Registeò A=° meanó thaô iô ió noô readù tï outpuô 
anotheò byte.

Discussion and Notes:
     Likå  thå CONSÔ routine¬  LISTSÔ doeó noô necessarilù affecô 
the Zero Flag.  Only the value in the A register is affected.

Input Parameters: None
Output Parameters:
     A = 0FFH if the list device is ready to output another byte
     A = 0    if the list device is not ready

3.4. IOP Patch

     Thå  IOĞ Patcè routinå ió useä tï changå thå addresó oæ  thå 
devicå driveò foò á particulaò consolå device®  Therå ió onlù onå 
IOP Patch routine:
.uj 0

     Section   Offset    Mnemonic  Description of Routine
               Hex Dec
     IOP Patch  21  33   PATCH     Patch Console
.uj 1

Brief Description:
     PATCÈ  allowó  thå  programmeò tï temporarilù  tesô  aî  I/Ï 
devicå  driveò bù forcinç thå IOĞ tï indeø intï á triï oæ  CONST¬ 
CONIN, and CONOUT device drivers anywhere in memory.

Discussion and Notes:
     Thió  functioî  ió  noô  requireä  iî  aî  IOĞ  anä  maù  bå 
implemented only if desired.
     Oî  input¬  thå  HÌ registeò paiò containó thå addresó oæ  á 
jumğ tablå structureä aó follows:
.uj 0
          JMP  ISTAT     ;Input status (0=no byte, 0ffh=byte)
          JMP  INPUT     ;Input character
          JMP  OUTPUT    ;Output character
.uj 1
     PATCÈ replaceó aî implementer-selecteä consolå devicå driveò 
witè thå indicateä routines®   Notå thaô onlù onå oæ thå possiblå 
consolå devicå driveró ió replaced®   Hence¬ wheî thió consolå ió Šselecteä  (bù  NAMÅ - seå thå NAMEÒ routinå  documentation)¬  thå 
threå indicateä routineó arå calleä wheî thå  CONST¬  CONIN¬  anä 
CONOUT routines of the IOP are called.
     Sincå  onlù  onå consolå devicå driveò ió affecteä bù  this¬ 
otheò  consolå devicå driveró iî thå IOĞ arå stilì availablå  foò 
selection.
     Thió  featurå  oæ  thå IOĞ waó implementeä  solelù  foò  thå 
purposå oæ testinç á consolå devicå driver®   Otheò applications¬ 
particularlù  iî  thå areá oæ Remotå Accesó Systemó  (RASs)¬  arå 
possible.

Input Parameters:
     HL = address of three-entry jump table
Output Parameters: None

3.5. IOP Recorder Routines
.uj 0

     This section describes the IOP Recorder routines;

     Section   Offset    Mnemonic  Description of Routine
               Hex Dec
                24  36   COPEN     Open Console Recorder
     IOP        27  39   CCLOSE    Close Console Recorder
     Recorder   2A  42   LOPEN     Open List Recorder
                2D  45   LCLOSE    Close List Recorder
.uj 1

3.5.1. COPEN

Brief Description:
     COPEN enables an IO Recorder for the console.

Discussion and Notes:
     Thå  naturå oæ thå recordeò ió uğ tï thå implementeò oæ  thå 
IOP®  Thå namå oæ á filå maù bå passeä iî registeò paiò DE¬ wherå 
thå filå ió nameä iî aî FCÂ whicè ió structureä aó follows:
.uj 0

          db   disk      ;disk A = 1, current disk = 0
          db   'FILENAME'
          db   'TYP'
          db   0
          db   user      ;user 0 = 0
.uj 1

     Iæ  thió informatioî ió tï bå useä bù thå  IÏ  Recorder¬  iô 
should be copied into an FCB within the IOP for safe keeping.
     Undeò  ZRDOS-Plus¬  redirectioî  oæ I/Ï tï á  disë  filå  ió 
possiblå sincå ZRDOS-Pluó supportó one-leveì reentrancy.
.uj 0
     Two applications of the console IO Recorder are:
          1. redirection of characters going to the console
               into a disk file
          2. redirection of characters going to the console
               into a physical device, such as a remote
               computer
.uj 1
     Thå  STATUÓ  routinå  oæ  thå IOĞ returnó witè  thå  MSÂ  oæ 
registeò Á seô iæ thå IOĞ supportó IÏ Recording.
     Thå  COPEÎ  functioî  musô bå associateä  witè  alì  consolå 
devicå drivers.Š
Input Parameters:
     HL = address of an FCB indicating the file (optional)
Output Parameters: None

3.5.2. CCLOSE

Brief Description:
     CCLOSE terminates the console IO Recorder operation.

Discussion and Notes:
     Iæ  COPEÎ recordeä tï á disë file¬  CCLOSÅ woulä closå  thaô 
disk file.
     Iæ COPEÎ senô outpuô tï á device¬  sucè aó remotå  computer¬ 
CCLOSÅ  maù senä á speciaì controì codå tï thå devicå tï instrucô 
it to terminate recording.
     Thå  CCLOSÅ  routinå  musô bå associateä  witè  alì  consolå 
device drivers.

Input Parameters: None
Output Parameters: None

3.5.3. LOPEN

Brief Description:
     LOPEN opens the IO Recorder for the list device.

Discussion and Notes: See COPEN.
Input Parameters:
     HL = address of FCB (optional)
Output Parameters: None

3.5.4. LCLOSE

Brief Description:
     LCLOSE closes the IO Recorder for the list device.

Discussion and Notes: See COPEN and CCLOSE.
Input Parameters: None
Output Parameters: None
