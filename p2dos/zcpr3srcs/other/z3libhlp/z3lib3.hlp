Introduction           ZCPR3 Flow Control
End IF                   IFEND
Raise IF                 IFT IFF
Test IF                  IFTEST
Toggle IF                IFELSE
Introduction           ZEX Access and Control
ZEX Data                 GETZFC GETZNC  GETZRUN PUTZNC  PUTZRUN
ZEX Status and Control   GETZEX HALTZEX PUTZEX  STOPZEX STRTZEX
:Introduction to ZCPR3 Flow Control

Basic Defintion of Flow Control:

     Alì commanä sequenceó issued undeò ZCPR³ caî bå thoughô 
tï  executå  withiî  á TRUÅ flo÷ controì  state®   Thaô  is¬ 
wheneveò  á commanä ió executeä undeò ZCPR3¬  thå  statå  oæ 
flo÷ controì ió TRUE®  Iæ thå statå oæ flo÷ controì ió FALSÅ 
theî nï commandó excepô flo÷ commandó wilì bå executeä untiì 
the state of flow control becomes TRUE.

Background:

     Wheî ZCPR³ firsô comeó up¬ thå statå oæ flo÷ controì ió 
alwayó  TRUE®   Anù commanä issueä wilì bå executed®   Iæ  á 
Flo÷   Commanä  Packagå  ió  installeä  whicè  supportó  thå 
IF/ELSE/FÉ (Enä IF© commands¬ theî thå statå oæ flo÷ controì 
caî bå changeä bù useò commands®  Foò example¬ thå followinç 
terminal session illustrates:


SCR>; any command will execute now
SCR>era *.bak
No Files
SCR>dir
MYFILE  .TXT  |  OBJECT  .BIN
SCR>; we can set a flow control state to be false
SCR>IF F
 IF F
SCR>; no command will execute now
SCR>dir
SCR>else
 IF T
SCR>dir
MYFILE  .TXT  |  OBJECT  .BIN
SCR>FI
 No IF
SCR>


     Hence¬   wheî  anù  commanä  ió  executed¬  beforå  thå 
executioî  actuallù begins¬  ZCPR³ wilì looë tï seå  iæ  thå 
statå oæ thå flo÷ controì ió TRUE®  Sucè ió thå caså wheî wå 
arå  noô withiî aî IÆ conditioî oò wheî wå arå withiî onå oò 
more IF conditions, all of which are TRUE.

     ZCPR³ allowó thå useò tï bå nesteä intï IFó uğ tï eighô 
(8©  leveló deep®   Thaô is¬  thå structurå oæ  hió  commanä 
sequenceó  caî takå thå forí oæ somethinç likå thå followinç 
which can be nested into 8 levels of IFs:


<set of commands>
IF T
     <set of commands>
     IF T
          <set of commands>
          IF T
               <set of commands>
          FI
          <set of commands>
     ELSE
          <set of non-executed commands>
          IF T
               <set of non-executed commands>
          FI
     FI
ELSE
     <set of non-executed commands>
FI


     Commanä  structureó likå thoså presenteä abovå arå  no÷ 
possiblå undeò ZCPR3®   Essentially¬  ZCPR³ commandó caî no÷ 
take the form of a programming language in their own right.     

     Thå seô oæ routineó availablå iî thió parô oæ Z3LIÂ arå 
useä tï providå thå programmeò á simplå interfacå tï controì 
thå flo÷ controì withiî (anä outside© hió program®   Hå can¬ 
undeò hió owî control¬  issuå commandó tï:

     ® enteò thå nexô IÆ leveì iî á TRUÅ oò FALSÅ condition,
     . toggle the state of the current IF level,
     . drop down to the previous IF level,
     . determine the current IF level number,
     . or multiples of the above


:End IF Level

Z3LIB Routine: IFEND

Function:
     Droğ  tï  thå  previouó IÆ level®   Iæ thå  prograí  ió 
currentlù withiî onå oò morå IFs¬  IFENÄ wilì droğ iô tï thå 
next IF level down, terminating the current IF level.

     Naturally¬  foò á transienô tï bå executinç now¬  therå 
ió  currentlù  eitheò nï IÆ leveì oò therå ió  á  TRUÅ  flo÷ 
controì  statå (alì preceedinç IFó arå TRUE)®   Iæ wå arå aô 
somå  IÆ level¬  callinç IFENÄ dropó uó intï thå  preceedinç 
one.

Inputs: None

Outputs: A=0 and Zero Flag Set (Z) if no IF level
          A=0FFH and NZ if IFEND is successful


Registers Affected: PSW

Side Effects: None

Special Error Conditions: None

:Raise IF

Z3LIB Routine: IFT/IFF

Function:
     Raiså thå flo÷ controì statå intï thå nexô leveì oæ IF®  
IFÔ  raiseó  thå statå intï thå nexô leveì anä  setó  iô  tï 
TRUE¬  whilå  IFÆ  raiseó thå statå intï thå nexô leveì  anä 
sets it to FALSE.

     Thå flo÷ controì statå caî supporô eighô (8© leveló  oæ 
IFs¬  anä  IFÔ  anä IFÆ returî erroò codeó indicatinç iæ  aî 
overflo÷  (anä subsequenô failurå tï enteò thå  nexô  state© 
occurred.

Inputs: None

Outputs: A=0 and Zero Flag Set (Z) if IF level overflow
          A=0FFH and NZ if IF level OK


Registers Affected: PSW

Side Effects: None

Special Error Conditions: None

:Test IF

Z3LIB Routine: IFTEST

Function:
     Tï  determinå thå currenô IÆ level®   IFTESÔ returnó  á 
valuå froí ° tï ¸ iî thå Á register¬  indicatinç thå currenô 
IÆ level®  Iæ A=0¬ therå ió nï currenô IF®  Thå Zerï Flaç ió 
set accordingly, so the following can be done:

          ext  IFTEST
          ...
          call iftest    ;get IF level
          jz   noif      ;process if not any IF level
          cpi  8         ;test for max IF level
          jz   atmax     ;process if at max IF level
          ...

Inputs: None


Outputs: A = number of current IF level, Zero Flag set
               accordingly

Registers Affected: PSW

Side Effects: None

Special Error Conditions: None

:Toggle IF

Z3LIB Routine: IFELSE

Function:
     Togglå  thå  TRUE/FALSÅ statå oæ thå currenô IÆ  level®  
IÆ thå prograí ió currentlù withiî aî IÆ leveì (theî iô MUSÔ 
bå withiî á TRUÅ IÆ level)¬ callinç IFELSÅ (aî odä numbeò oæ 
times© toggleó thå IÆ leveì tï FALSE®   Twï calló tï  IFELSÅ 
(anù  eveî numbeò oæ calls© resulô iî thå IÆ leveì remaininç 
aô TRUE.

Inputs: None

Outputs: A=0 and Zero Flag Set (Z) if no current IF
          A=0FFH and NZ if successful


Registers Affected: PSW

Side Effects: None

Special Error Conditions: None

:Introduction to ZEX Access and Control

     Thå  ZEØ Commanä Filå Facilitù (undeò ZCPR³ only!©  caî 
bå controlleä bù thió seô oæ Z3LIÂ routines®  ZEØ interceptó 
alì BIOÓ calló foò input¬  and¬  wheî iî intercepô mode¬  iô 
provideó  inpuô froí texô containeä iî itó memory-baseä texô 
buffeò  ratheò  thaî allowinç thå useò tï  inpuô  characteró 
froí  thå keyboard®   Theså routineó arå useä tï  querù  thå 
statuó  oæ ZEØ anä tï instrucô ZEØ tï continuå  interceptinç 
characteró oò tï stoğ interceptinç characteró anä allo÷ useò 
input.

     Thió seô oæ routineó provideó accesó tï thå ZEØ memory-
baseä  commanä  filå  processoò anä  itó  environment®   Thå 
programmer can take control of ZEX through these routines.


     Summary of Routines:

          GETZEX  - Get the ZEX Control Message
          GETZFC  - Get the first character in ZEX buffer
          GETZNC  - Get the next character to be returned
          GETZRUN - Get ZEX Running Flag

          HALTZEX - Terminate the ZEX processor

          PUTZEX  - Set the ZEX Control Message
          PUTZNC  - Set the next character to be returned
          PUTZRUN - Set ZEX Running Flag

          STOPZEX - Suspend ZEX Execution
          STRTZEX - Resume ZEX Execution from a STOPZEX

:ZEX Data      GETZFC GETZNC GETZRUN PUTZNC PUTZRUN

Z3LIB Routine: GETZFC

Function:
     GETZFÃ returnó thå addresó iî HÌ oæ thå firsô characteò 
iî  thå ZEØ texô buffer®   Carrù Flaç ió seô iæ datá ió  noô 
available.

Inputs: None

Outputs: HL = Address of First Character
               A = Character
               Carry Flag Set (C) if No Data

Registers Affected: HL, PSW

Side Effects: None

Special Error Conditions: None

Z3LIB Routine: GETZNC

Function:
     GETZNÃ  returnó thå addresó iî HÌ oæ thå nexô characteò 
whicè ZEØ wilì return®  Carrù Flaç ió Seô iæ nï data®  Reç Á 
contains the character.

Inputs: None

Outputs: HL = Address of Next Character in ZEX Text Buffer
               A = Next Character in ZEX Text Buffer
               Carry Flag Set (C) if no data

Registers Affected: HL, PSW

Side Effects: None

Special Error Conditions: None


Z3LIB Routine: GETZRUN

Function:
     GETZRUÎ  returnó thå ZEØ Ruî Messagå Bytå iî  A®   Zerï 
Flaç  ió seô accordingly®   Carrù Flaç ió Seô iæ nï  messagå 
available®   Thió messagå indicateó iæ ZEØ ió runninç oò noô 
(A=0 if not running).

Inputs: None

Outputs: A = ZEX Run Message
               Carry Flag Set (C) if no data

Registers Affected: PSW

Side Effects: None

Special Error Conditions: None


Z3LIB Routine: PUTZNC

Function:
     PUTZNÃ setó thå addresó oæ thå nexô characteò whicè ZEØ 
wilì returî tï thaô containeä iî HL®   Thió routinå provideó 
a GOTO function for ZEX control.

Inputs: HL = address of next character ZEX will return

Outputs: Carry Flag Set (C) if data not available
               (Message Buffers not available)

Registers Affected: PSW

Side Effects: ZEX Next Character Address Message is set

Special Error Conditions: None


Z3LIB Routine: PUTZRUN

Function:
     PUTZRUÎ setó thå ZEØ Runninç Messagå bytå tï thå  valuå 
iî  thå  Á register®   Carrù Flaç ió Seô upoî returî  iæ  nï 
messageó  arå supported®   Thió messagå indicateó iæ ZEØ  ió 
running¬ anä A=° iæ ZEØ ió noô running.

Inputs: A=Value of ZEX Running Message Byte

Outputs: Carry Flag Set if no message buffers

Registers Affected: PSW

Side Effects: ZEX Running Message Byte is set

Special Error Conditions: None

:ZEX Status and Control  GETZEX HALTZEX PUTZEX STOPZEX STRTZEX

Z3LIB Routine: GETZEX

Function:
     Returnó thå ZEØ controì messagå bytå iî A®  Thió allowó 
thå  prograí  tï finä ouô thå currenô statå thaô ZEØ ió  in®  
This control message byte takes on one of three values:

          0 - "normal" - ZEX is running and intercepting
               BIOS calls
          1 - "ZCPR3 Prompt" - ZEX is allowed to run and
               intercept BIOS calls but ZEX thinks that it
               is providing input to the ZCPR3 command
               Processor directly (ZEX is not providing
               input to any program)
          2 - "ZEX suspended" - ZEX is not intercepting
               BIOS calls and user input is allowed


     Thå codå oæ ± shoulä neveò bå seeî bù anù prograí sincå 
iô ió seô bù ZCPR³ anä cleareä tï ° afteò ZEØ haó  completeä 
the command line input.

     Anù  ZEØ  controì  messagå ió reseô upoî  executioî  oæ 
ZCPR³  tï  ° wheî ZCPR³ ió entereä anä theî tï  ±  wheî  thå 
ZCPR³  prompô appearó (ZCPR³ input)®   Wheî ZCPR³  completeó 
its input, it resets the ZEX control message to 0.

Inputs: None

Outputsº Á ½ ZEØ Controì Messagå anä Zerï Flaç set
         accordingly
          A = 0 if ZEX is intercepting chars
          A = 1 if ZCPR3 input is engaged and ZEX is
               intercepting chars
          A = 2 if ZEX is not intercepting chars


Registers Affected: PSW

Side Effects: None

Special Error Conditions: None


Z3LIB Routine: HALTZEX

Function:

     HALTZEØ  terminateó  executioî  oæ thå  ZEØ  processor®  
STOPZEØ  suspendó executioî oæ ZEØ (anä STRTZEØ  caî  resumå 
it)¬  buô HALTZEØ causeó ZEØ tï terminatå itselæ completely®  
Iô  doeó thió bù settinç thå nexô characteò ZEØ wilì procesó 
to 0FFH (the termination character).

Inputs: None

Outputs: 
     A=0 and Zero Flag Set (Z) if ZEX not running
     A=0FFH and NZ if ZEX halted

Registers Affected: PSW
Side Effects: ZEX is halted if running
Special Error Conditions: None

Z3LIB Routine: PUTZEX

Function:
     Setó  thå ZEØ controì messagå bytå iî A®   Thió  allowó 
thå  prograí tï seô thå statå thaô ZEØ ió in®   Thió controì 
messagå bytå musô takå oî onå oæ threå values:

          0 - "normal" - ZEX is running and intercepting
               BIOS calls
          1 - "ZCPR3 Prompt" - ZEX is allowed to run and
               intercept BIOS calls but ZEX thinks that it
               is providing input to the ZCPR3 command
               Processor directly (ZEX is not providing
               input to any program)
          2 - "ZEX suspended" - ZEX is not intercepting
               BIOS calls and user input is allowed

     Iô  ió  thå  responsibilitù oæ thå  programmeò  thaô  Á 
contains one of these three values upon entry to PUTZEX.

     Thå codå oæ ± maù bå seô bù anù prograí iæ iô wantó ZEØ 
tï "think¢ thaô iô ió providinç inpuô tï ZCPR3®   Iæ ZEØ waó 
previouslù  suspended¬  iô advanceó tï thå beginninç oæ  thå 
nexô linå anä resumeó wheî iô seeó thió code.

     Anù  ZEØ  controì  messagå ió reseô upoî  executioî  oæ 
ZCPR³  tï  ° wheî ZCPR³ ió entereä anä theî tï  ±  wheî  thå 
ZCPR³  prompô appearó (ZCPR³ input)®   Wheî ZCPR³  completeó 
its input, it resets the ZEX control message to 0.

Inputsº Á ½ ZEØ Controì Messagå
          A = 0 if ZEX is intercepting chars
          A = 1 if ZCPR3 input is engaged and ZEX is
               intercepting chars
          A = 2 if ZEX is not intercepting chars

Outputs: None


Registers Affected: None

Side Effects: ZEX Control Message Byte is Set

Special Error Conditions: None


Z3LIB Routine: STOPZEX

Function:
     Stoğ  ZEØ  froí interceptinç BIOÓ calló anä  allo÷  thå 
user to input characters.

     Thió ió á shorthanä tï placinç thå 2 controì codå  intï 
the ZEX Control Message Byte.

Inputs: None

Outputs: None

Registers Affected: None

Side Effects: ZEX Control Message Byte is set to 2

Special Error Conditions: None


Z3LIB Routine: STRTZEX

Function:
     Allo÷  ZEØ tï intercepô BIOÓ calló anä don'ô allo÷  thå 
useò tï inpuô characters.

     Thió ió á shorthanä tï placinç thå 0 controì codå  intï 
the ZEX Control Message Byte.

Inputs: None

Outputs: None

Registers Affected: None

Side Effects: ZEX Control Message Byte is set to 0

Special Error Conditions: None

