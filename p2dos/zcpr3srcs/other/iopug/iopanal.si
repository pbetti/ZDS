




.PN 1
.FO                                4-#
4. Analysis of a Sample IOP

     Thió chapteò ió á runninç commentarù oî thå Samplå IOĞ whoså 
sourcå  codå  ió  presenteä iî Appendiø  B®   Alì  commentarù  ió 
referenceä  bù  thå  linå  numberó giveî  iî  thió  sourcå  code®  
Sectioî  ± oæ Appendiø Â shoulä bå examineä whilå readinç througè 
thió chapter.

4.1. Analysis of the Sample IOP Source

     Lineó ± tï 3¸ compriså thå fronô oæ thå IOP®   Notå thå baså 
addresó oæ thå IOĞ oî linå 6¬  thå jumğ tablå oî lineó 1¶ tï  34¬ 
anä thå IOĞ IÄ oî linå 38®   Wheî LDÒ loadó aî IOP¬  iô checkó tï 
seå  thaô  thå  propeò numbeò oæ jumpó anä thaô thå  IOĞ  IÄ  arå 
present.

4.1.1. STATUS, SELECT, and NAMER Routines

     Thå  STATUS¬  SELECT¬  anä NAMEÒ routineó arå iî lineó 4¹ tï 
130®   Iô ió througè theså routineó thaô thå externaì environmenô 
determineó thå attributeó oæ thå IOĞ anä issueó devicå  selectioî 
commands to the IOP.
     STATUÓ   returnó  thå  addresó  oæ  thå  IOĞ  Statuó   Tablå 
(IOPTABLE)¬ whicè ió showî iî lineó 4³ tï 47®  Thió tablå ió useä 
tï  determinå ho÷ manù devicå driveró foò eacè logicaì devicå arå 
availablå anä whicè devicå driveò ió currentlù selected®   STATUÓ 
alsï  returnó  á  valuå iî A®   Thå MSÂ oæ Á ió  seô  iæ  thå  IÏ 
Recordeò  functioî  oæ  thå  IOĞ ió supported®   Thå  resô  oæ  Á 
containó  á  numbeò  froí  ± tï 12· whicè  ió  useä  bù  thå  IOĞ 
implementeò  tï identifù thå IOP®   Iæ thå valuå oæ Á ió 0¬  theî 
thå  IOĞ ió considereä tï bå non-operationaì bù thå  ZCPR³  tooló 
whicè  addresó thå IOP®   Thå IOĞ numbeò ió noô useä bù anù ZCPR³ 
tools except to insure that this value is not zero.
     SELECÔ ió useä tï assigî á devicå driveò foò á giveî logicaì 
device®   Thå logicaì devicå ió identifieä bù thå Â register¬ anä 
thå desireä driveò ió identifieä bù thå Ã register®   Â musô havå 
á valuå froí ° tï ³ oò aî erroò conditioî ió returneä (seå  lineó 
6¸ tï 70)®  B=° selectó thå COÎ device¬ ± thå RDR¬ ² thå PUN¬ anä 
³ selectó thå LSÔ device.
     Lineó  6¸ tï 7¸ arå useä tï locatå thå bytå paiò  associateä 
witè á giveî logicaì device®  Sincå IOPTABLÅ consistó oæ two-bytå 
entries¬ thå valuå oæ Â (whicè ió ° tï 3© ió doubleä (tï 0¬ 2¬ 4¬ 
6© anä useä aó aî offseô froí thå baså addresó oæ IOPTABLE®  Thió 
locateó  thå desireä bytå pair®   Lineó 7µ tï 7¸ theî comparå thå 
maximuí numbeò oæ deviceó tï thå requesteä device¬  insurinç thaô 
thå  requesteä  devicå numbeò ió withiî  range®   Iæ  noô  withiî 
range¬  thå  erroò  routinå (SELERR© ió brancheä to®   Iæ  withiî 
range¬  thå pointeò ió advanceä tï thå 2nä bytå oæ thå bytå  paiò 
(linå 79)¬ anä thå ne÷ devicå ió selecteä bù storinç thå contentó 
oæ Ã intï thå currenô selectioî bytå (linå 80).
.cp 2Š     NAMEÒ ió useä tï returî á strinç whicè nameó á devicå driveò 
anä  optionallù provideó á description®   Likå thå SELECÔ  input¬ 
NAMEÒ  expectó á logicaì devicå numbeò iî Â (° tï 3© anä á devicå 
driveò  numbeò iî C®   Thå indexinç anä erroò checkinç  iî  NAMEÒ 
(seå  lineó  9µ  tï 106© arå similaò tï thoså  iî  SELECT®   Oncå 
certaiî thaô Â anä Ã arå withiî range¬ NAMEÒ theî indexeó througè 
two address tables to locate the string.
     Thå  firsô table¬  IOPDNAMES¬  ió addresseä bù thå  codå  iî 
lineó  10· tï 112®   Thå tablå IOPDNAMEÓ ió iî lineó 13¶ tï  140®  
Aô  linå  107¬  DÅ containó thå offseô (0¬  2¬  4¬  6©  intï  thå 
IOPDNAMEÓ  tablå  foò  thå  CON¬   RDR¬  PUN¬  anä  LSÔ  devices¬ 
respectively®   Afteò  linå  11²  ió executed¬  HÌ  containó  thå 
addresó oæ á tablå oæ addresseó foò thå stringó associateä witè á 
particulaò logicaì device®   Iî thió case¬  HÌ containó thå valuå 
of one of these symbols:
.uj 0

      CONNAMES       RDRNAMES       PUNNAMES       LSTNAMES
.uj 1

See lines 132 to 173 for a review of these tables.
     No÷  thaô thå addresó oæ thå desireä addresó tablå ió known¬ 
thå  codå  indexeó  intï thió tablå baseä oî  thå  devicå  driveò 
identifieä iî thå Ã register®  Lineó 11³ tï 12± dï thió indexing®  
Likå thå codå iî lineó 9¶ tï 112¬  thå techniquå oæ doublinç  thå 
indeø  valuå (iî thå Ã registeò aô linå 113© anä theî addinç thió 
tï  HL¬  whicè  containó thå baså addresó oæ thå  strinç  addresó 
tablå foò á particulaò logicaì device¬  ió applied®   Afteò  linå 
11·  ió executed¬  HÌ containó thå addresó oæ thå addresó oæ  thå 
desireä  string®   Lineó  11¸ tï 12± simplù extracô thå  string'ó 
addresó anä returî iô iî HL.
     Notå that¬  foò thå sakå oæ debugging¬  thå NAMERROÒ routinå 
noô onlù returnó thå erroò codå (A=° anä Zerï Flaç Set)¬  buô  iô 
also returns the address of an Error Message in HL.
     Thå stringó iî lineó 16± tï 17² providå nameó tï thå variouó 
devices®  Notå thaô wheî nï descriptionó arå provideä (lineó 161¬ 
162¬ 167¬ 169¬ 171¬ anä 172)¬ thå nameó arå terminateä bù á spacå 
followeä bù aî endinç ° (thå strinç terminator)®   Alsï notå thaô 
thå nameó arå capitalized.

4.1.2. Initialization and Device Drivers

     Thå  INIÔ  routinå  iî lineó 17´ tï 18± ió  simplå  iî  thió 
example®  Iô turnó ofæ thå IÏ Recordeò flags®  Iî á differenô IOĞ 
implementation¬   withiî  thå  INIÔ  routinå  woulä  bå  codå  tï 
configurå  thå UARTÓ (· oò ¸ bits¬  paritù oò  none¬  bauä  rate¬ 
etc).
     Lineó 19² tï 23± sho÷ thå fouò basiã routineó foò  providinç 
I/Ï tï thå CRÔ hardware®  Notå thaô theóe exampleó show thå CRT'ó 
UARÔ  aó  beinç memorù mappeä (LDÁ anä STÁ instructionó arå  useä 
insteaä  oæ  IÎ  anä OUT)¬  anä thå datá anä  statuó  valueó  arå 
inverteä (notå thå CMÁ instructionó iî lineó 203¬  211¬  221¬ anä 
229)®   Thå valueó returneä anä thå registeò conventionó useä arå 
compatiblå  witè thoså requireä foò thå BIOÓ routineó likå  CONIÎ 
and CONOUT (ie, passing output character in the C register).
     Lineó  23´ tï 27µ sho÷ thå fouò basiã routineó foò providinç 
I/Ï tï thå modeí hardware®   Theså exampleó sho÷ thå modem'ó UARÔ 
aó beinç I/Ï mappeä (IÎ anä OUÔ arå used)®   Similarly¬ lineó 27¸ Štï  31²  sho÷ thå fouò basiã routineó foò providinç  I/Ï  tï  thå 
printer hardware.

4.1.3. BIOS Interface Routines

     Lineó  31´ tï 37µ contaiî thå routineó entereä froí thå jumğ 
tablå  whicè  arå indexeä intï  froí  thå  BIOS®   Namely¬  theså 
routines (lines 317 to 345) are:
.uj 0

    CONST     CONIN     CONOUT    LIST      PUNCH     READER
    LISTST
.uj 1

     Iî alì cases¬  thå inpuô anä statuó routineó (CONST¬  CONIN¬ 
READER¬ LISTST© returî theiò valueó iî thå Á registeò anä requirå 
nï inpuô values¬  anä thå outpuô routineó (CONOUT¬  LIST¬  PUNCH© 
obtaiî  thå valueó tï outpuô froí thå Ã register®   Consequently¬ 
sincå Ã carrieó thå onlù inpuô value¬  thå samå codå (DRVRUN© caî 
bå useä tï procesó alì oæ thå BIOÓ entrù routineó iæ DRVRUÎ  doeó 
not have an effect on the C register.
     Thå routineó arå table-driven®   DRVRUÎ acceptó aó inpuô thå 
addresó  oæ thå tablå foò thå logicaì devicå iî HÌ anä thå numbeò 
oæ thå logicaì devicå iî Â (aó foò thå SELECÔ anä NAMEÒ routines¬ 
Â containó á valuå froí ° tï 3)®   DRVRUÎ useó thå valuå iî Â  tï 
obtaiî  thå  numbeò oæ thå currently-selecteä devicå driveò  froí 
thå IOPTABLÅ (seå lineó 35¶ tï 363)®  Afteò linå 36³ ió executed¬ 
Â containó thå numbeò oæ thå desireä devicå driver®  Lineó 36´ tï 
36·  theî doublå thió numbeò (iî ordeò tï uså iô aó  aî  offset)¬ 
anä placå iô intï DE®  Linå 36¸ obtainó thå addresó oæ thå devicå 
driver address table.
     Afteò linå 36¸ ió executed¬  HÌ containó thå address oæ onå oæ 
the following tables:
.uj 0

    TCONST    TCONIN    TCONOUT   TLIST     TREADER   TPUNCH
    TLISTST
.uj 1

DÅ  containó  thå offseô intï thå tablå pointeä tï bù  HÌ  which¬ 
wheî addeä tï HÌ (linå 369)¬  provideó thå addresó oæ thå addresó 
oæ thå devicå driver®  Lineó 37° tï 37³ obtaiî thå addresó oæ thå 
devicå driveò iî HL¬ anä linå 37´ (PCHL© transferó controì tï thå 
device driver.
     Note the device driver tables in lines 376 to 416.

4.1.4. IO Recorder

     Thå  IÏ Recordeò functioî ió addresseä iî thå BIOÓ Interfacå 
Routines®   Notå  thå calì tï CRECORÄ iî linå 32¶ anä LRECORÄ  iî 
linå  331®   Thå codå oæ CRECORÄ anä LRECORÄ ió iî lineó  44³  tï 
454®   Notå that¬  iî thió particulaò implementation¬ CRECORÄ anä 
LRECORÄ  simplù  senä thå characteò tï bå outpuô tï thå Modeí  iæ 
thå CREÃ anä LREÃ flags¬  respectively¬  arå set®   Remembeò  thå 
initializatioî routine¬  INIT¬ iî lineó 17· tï 181¿  Alì INIÔ diä 
waó cleaò theså flagó sï thå IOĞ woulä noô comå uğ witè recordinç 
on.
     Iî  thió  implementation¬  thå IÏ Recordeò  serveó  tï  senä 
outpuô  tï  thå Modeí aó welì aó tï thå selecteä CONOUÔ  oò  LISÔ 
device®  Iî operation¬ thå useò ió expecteä tï havå ruî á prograí Šoî  thå  computeò aô thå otheò enä oæ thå Modeí connectioî  whicè 
receiveó  characters¬  sendó á ^Ó wheî itó buffeò ió  fulì  (notå 
thaô MODOUÔ iî lineó 26³ tï 27µ payó attentioî tï ^S)¬ writeó itó 
buffeò  tï  disk¬  anä  theî sendó somå otheò characteò  (^Q©  tï 
resumå transmissioî througè thå MODOUÔ driver®  Thå ZCPR³ commanä 
linå  "RECORÄ  ON¢ calló thå COPEÎ routinå (lineó  46°  tï  463)¬ 
whicè  simplù setó thå CREÃ flaç tï true®   Likewise¬  "RECORÄ OÎ 
PRINTER¢  calló thå LOPEÎ routinå (lineó 47°  tï  473)®   "RECORÄ 
OFF¢ calló thå CCLOSÅ routinå (lineó 46´ tï 469© whicè clearó thå 
CREÃ  flaç  anä sendó á ^Ú tï thå modeí (whicè telló thå  prograí 
runninç therå tï closå itó filå anä exit)®   Likewiså foò  LCLOSÅ 
(lines 474 to 479).
     Iî  lookinç  back¬  É realizå thaô MODOUÔ shoulä  havå  alsï 
checkeä  foò thå outpuô oæ ^Ú anä noô alloweä iô sï thå  recordeò 
oî  thå  computeò  tieä  tï  thå  modeí  woulä  noô  accidentallù 
terminatå operation®  Slighô oversight.

4.1.5. Hardware Combinations

     Thå  simplå devicå driveró iî lineó 19² tï 31³ caî bå easilù 
combineä intï "hybrid¢ devices®  Thå routineó iî lineó 41· tï 43¹ 
sho÷ sucè devices®   CRTMODISÔ returnó thå inpuô statuó froí  thå 
CRÔ  anä  Modeí  iî parallel®   Iô indicateó iæ  á  characteò  ió 
pendinç oî eitheò device®  CRTMODIÎ inputó á characteò froí á CRÔ 
anä  Modeí combination¬  wherå thå characteò inpuô comeó froí thå 
CRÔ  oò  thå  Modem¬   whicheveò  receiveó  á  characteò   first®  
CRTMODOUÔ outputó tï thå CRÔ anä Modeí iî paralleì (notå thaô thå 
Ã  registeò  containó  thå characteò tï output¬  anä  CRTOUÔ  anä 
MODOUÔ  dï  noô affecô thå Ã registeò iî lineó 225-23±  anä  263-
275)®  CRTPRTOUÔ ió similaò tï CRTMODOUT.
     Theså  combinationó  oæ  deviceó arå  declareä  tï  thå  IOĞ 
througè  thå devicå driveò tableó (lineó 37¶ tï 415)®   Notå thaô 
thå  thirä  consolå  (selecteä  driveò ió  2©  ió  identifieä  bù 
CRTMODISÔ  (linå 382© foò inpuô status¬  CRTMODIÎ (linå 390©  foò 
input¬  anä CRTMODOUÔ (linå 398© foò output®  Thió ió thå CRÔ anä 
Modeí iî paralleì foò botè inpuô anä output®   Iî  contrast¬  thå 
fourtè  consolå (selecteä driveò ió 3© ió identifieä bù  CRTISTAÔ 
(linå  383©  foò inpuô status¬  CRTIÎ (linå 391© foò  input¬  anä 
CRTPRTOUÔ (linå 399© foò output®   Thió ió thå CRÔ inpuô witè CRÔ 
and printer output.

4.1.6. IOP Patching

     Thå  PATCÈ routinå ió thå lasô tï bå discussed®   Iô  ió  iî 
lineó  48´ tï 500®   Notå thaô itó solå purposå ió tï changå  thå 
addresseó  foò  thå fiftè consolå (selecteä driveò  ió  4)®   Thå 
addresseó foò PATISTAT¬  PATIN¬ anä PATOUÔ arå iî lineó 384¬ 392¬ 
and 400, respectively.
     PATCÈ   ió  extremelù  usefuì  iî  debugginç  candidatå  IOĞ 
routines®  Thå consolå caî selecô thå TESÔ devicå (viá thå SELECÔ 
routine)¬  thå tesô caî bå done¬  anä theî thå consolå caî selecô 
some other console device to restore order.
.paŠ4.1.7. Adding Device Drivers

     Thå  samplå  IOĞ caî bå easilù modifieä tï  adä  anä  removå 
devicå  drivers®   Thå codå foò thå devicå driveò itselæ musô  bå 
added¬ anä thå followinç changeó musô bå made:
.uj 0

      1. modify the number of devices in IOPTABLE (lines 43-47)
      2® modify thå strinç addresó tableó (lineó 145-157)
      3. modify the strings (lines 161-172)
      4. modify the device driver tables (lines 376-415):
              Console - Change TCONST, TCONIN, TCONOUT
              Reader  - Change TREADER
              Punch   - Change TPUNCH
              List    - Change TLIST, TLISTST
.uj 1

4.2. Terminal Session

     Thå  terminaì sessioî iî sectioî ² oæ Appendiø Â  showó  ho÷ 
thå  IOĞ  whicè waó analyzeä abovå ió assembleä anä prepareä  foò 
uså  oî á ZCPR³ system®   Thå commandó arå discusseä iî ordeò  iî 
the following paragraphs.
     Thå  commanä  "lasí  samiop.bbz¢  assembleó  SAMIOP.ASÍ  anä 
generateó SAMIOP.HEØ oî drivå B®  Thå commanä "mloaä samiop¢ theî 
creates SAMIOP.COM from SAMIOP.HEX (the assembler output).
     SAMIOP.COÍ  ió  noô á truå COÍ file®   Iô ió ORGeä  aô  somå 
valuå otheò thaî 100È (seå lineó 6-1± iî thå Samplå IOĞ listing)®  
Thå  commanä "reî sample.iop=samiop.com¢ createó thå desireä  IOĞ 
file, with the file type of IOP.
     SAMPLE.IOĞ  ió theî loadeä intï thå IOĞ buffeò (anä  checkeä 
foò  validitù beforå thå load© bù thå commanä  "ldò  sample.iop"®  
The IOP is now active (the INIT routine was called by LDR).
     Thå  commanä  "deö ä a¢ displayó alì  devices®   Thå  devicå 
names and any descriptive comments are clearly displayed.
     Thå  commanä  "deö ã test¢ selectó thå devicå nameä TESÔ  aó 
thå CONsolå device®   Iî SAMPLE.IOP¬ TESÔ ió thå devicå whicè caî 
bå patcheä bù PATCH¬ anä iô defaultó tï thå CRÔ (whicè ió whù thå 
systeí ió stilì running)®   Thå commanä whicè follows¬ "deö ä c"¬ 
displays the console device names and current selection.
     Finally¬  "deö ã crt¢ reassignó thå devicå nameä CRÔ tï  thå 
CONsole.
