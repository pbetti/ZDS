Introduction   ZCPR3 Environment
Command Line   APPCL    CLRCL    GETCL1   GETCL2   PUTCL
CRT/PRT Data   GETCRT   GETPRT   PUTCRT   PUTPRT
External FCB   GETEFCB
Environment    GETENV   GETVID
FCP Address    GETFCP
Filenames      GETFN1   GETFN2   GETFNX   PUTFNX
Initialize     Z3INIT
:Introduction to the ZCPR3 Environment

     Anù  prograí runninç undeò ZCPR³ ió withiî whaô caî  bå 
calleä á ZCPR³ environment®   Á hosô oæ facilitieó anä  datá 
ió  availablå  tï thió prograí whicè á normaì  CP/Í  prograí 
doeó  noô have®   Foò instance¬  á prograí runninç undeò thå 
ZCPR³ environment:

          . can find out what name it was invoked by
          . can access a set of messages from ZCPR3 which
               tell it a number of things about how it was
               invoked
          ® caî senä messageó tï ZCPR³ anä programó which
               run after it completes
          . can find out many things about its environment,
               such as the processor speed, CRT and printer
               characteristics, maximum number of disks
          . can determine what characteristics the user's
               terminal has and make use of these to employ
               cursor addressing and other such functions

     Alì  oæ  thå  informatioî outlineä abovå  anä  morå  ió 
availablå tï anù runninç prograí thrõ thå ZCPR³  Environmenô 
Descriptor®   Thió  ió  á blocë oæ memorù (25¶ bytes©  whicè 
containó  addresseó  anä otheò datá iî  á  precisely-defineä 
format®   Aô installatioî time¬  thå ZCPR³ utilitieó caî  bå 
seô  uğ  tï internallù contaiî aî Environmenô Descriptoò  oò 
theù  caî  bå  installeä witè á pointeò  tï  aî  Environmenô 
Descriptoò  whicè resideó aô somå fixeä locatioî  iî  memorù 
(thió  ió  thå preferreä approach)®   Oncå thå  routineó  iî 
Z3LIÂ havå beeî initializeä witè knowledgå oæ thå addresó oæ 
thió  environmenô  descriptor¬  theù  caî  extracô  specifiã 
informatioî froí iô foò uså iî thå applicatioî program.


     Thå  followinç informatioî ió containeä withiî á  ZCPR³ 
Environment Descriptor:

     . address of External Path    . size of External Path
     . address of RCP              . size of RCP
     . address of FCP              . size of FCP
     . address of IOP              . size of IOP
     . address of Named Dir        . size of Named Dir
     . address of Command Line     . size of Command Line
     . address of Env Descriptor   . size of Env Descriptor
     . address of Shell Stack      . size of Shell Stack
     . address of Z3 Messages      . size of Stack Entries
     . address of External FCB     . address of External Stk
     . address of Wheel Byte       . quiet flag
     . processor speed             . DU approval flag
     . maximum disk allowed        . maximum user allowed
     ® datá oî CRÔ                 ® datá oî Printeò
     . two reserved file names     . ZCPR3 TERMCAP (Z3TCAP)


     Thå purposå oæ Z3LIÂ ió tï providå thå programmeò  witè 
easù  accesó  tï  thå informatioî iî thå  ZCPR³  Environmenô 
Descriptoò  anä  tï  allo÷ hií tï easilù makå  uså  oæ  thió 
information.  To illustrate, the some Z3LIB routines are:

          . GETPRT  - return data on the width, number of
                      lines, and form feed ability of the
                      printer
          . GETCL2  - return the address of the first char
                      of the next command to be run, if any
          . GETEFCB - return the address of the external
                      FCB so the program can determine its
                      name
          . SHPUSH  - push a command line on the shell stack
          ® SHPOĞ   - poğ á commanä linå froí thå shelì stk
          . IFT     - invoke the next IF level and make it T
          . IFEND   - back up to previous IF level


     Thió  HLĞ  filå describeó thoså  Z3LIÂ  routineó  whicè 
providå  accesó  tï thå ZCPR³ Environmenô  Descriptoò  data®  
All of these routines are of the general name:

          GETxxxxx

wherå  thå mnemoniã followinç thå GEÔ prefiø alludeó tï whaô 
information is being obtained.
:Command Line   APPCL  CLRCL  GETCL1  GETCL2  PUTCL

Z3LIB Routine: APPCL

Function:

     APPCÌ  appendó thå commanä strinç (endinç iî null© pteä 
tï  bù  HÌ tï thå enä oæ thå ZCPR³ commanä linå  buffeò  foò 
execution®   Á leadinç semicoloî ió prependeä tï allo÷  thió 
linå  tï  executå afteò thå lasô linå iî  thå  buffer®   Thå 
commanä linå buffeò contentó arå repackeä tï averô  overflo÷ 
in most cases.

     PUTCÌ  insertó thå commanä linå aó thå nexô commanä  iî 
thå buffer¬ whilå APPCÌ appendó thå commanä linå aó thå lasô 
commanä iî thå buffer®  Thió ió thå differencå betweeî APPCÌ 
and PUTCL.

     Erroò  flaç ió returned¬  indicatinç overruî oæ buffer®  
If buffer is overrun, original command line is not changed.


Inputs: 
     HL = address of command string to append

Outputs: 
     A = Error Code
          A=0 and Zero Flag Set (Z) if command line buffer
               overflows (no change to command line) or
               no command line buffer
          A=0FFH and NZ if append is complete

Registers Affected: PSW

Side Effects: Command Line buffer is changed

Special Error Conditions: None


Z3LIB Routine: CLRCL

Function:

     CLRCÌ  clearó thå commanä linå buffer¬  settinç  iô  tï 
empty®   Anù  remaininç  commandó iî thå buffeò wilì noô  bå 
executed when control is returned to ZCPR3.

Inputs: None

Outputs: 
     A = Error Code
          A=° anä Zerï Flaç Seô (Z© iæ nï commanä linå 
               buffer (no problem, anyway)
          A=0FFH and NZ if command line cleared

Registers Affected: PSW
Side Effects: Command line buffer cleared
Special Error Conditions: None

Z3LIB Routine: GETCL1

Function:
     Returnó  thå addresó oæ thå Commanä Linå Buffeò  iî  HÌ 
anä  itó  sizå (iî byte© iî A®   Thå Commanä Linå Buffeò  ió 
structured as follows:

          cmdline:
               dw   <address of next char to process>
               db   <size of buffer>
               db   <dummy used for BDOS READLN function>
               db   <characters in command line>
               db   0

     GETCL±  returnó  thå addresó oæ CMDLINÅ iî HÌ  anä  thå 
size (at CMDLINE+2) in A.


Inputs: None

Outputs: HL=address of CMDLINE, A=size

Registers Affected: HL, PSW

Side Effects: None

Special Error Conditions:
     HL = 0 if there is no command line buffer


Z3LIB Routine: GETCL2

Function:
     Returnó thå addresó oæ thå firsô characteò oæ thå  nexô 
commanä  tï bå executeä iî thå Commanä Linå Buffeò iî HÌ anä 
thå firsô characteò oæ thå nexô commanä iî A®   A=° anä  thå 
Zerï  Flaç ió Seô (Z© iæ therå arå nï furtheò characteró  iî 
the line.
     The Command Line Buffer is structured as follows:

          cmdline:
               dw   <address of next char to process>
               db   <size of buffer>
               db   <dummy used for BDOS READLN function>
               db   <characters in command line>
               db   0

     GETCL² returnó thå addresó containeä iî thå firsô D× aô 
thå labeì CMDLINÅ iî HÌ anä thå chaò aô thió addresó iî A.

Inputs: None

Outputs: HL=address of next command, A=first char

Registers Affected: HL, PSW

Side Effects: None

Special Error Conditions:
     HL = 0 if there is no Command Line Buffer.


Z3LIB Routine: PUTCL

Function:
     PUTCÌ  storeó  á commanä linå aó á prefiø iî thå  ZCPR³ 
commanä  linå buffer®   Thå buffeò contentó arå repackeä  sï 
thaô  aî overflo÷ ió averteä iî mosô cases®   Iæ  á  commanä 
alreadù existó iî thå buffer¬ thå ne÷ linå ió postfixeä witè 
a semicolon so continuation is enabled.

Inputs: HL = Address of command line (ending in 0)

Outputs: A=0 and Zero Flag Set (Z) if overflow (no change
               to command line in this case)
               A = 0FFH and NZ if OK

Registers Affected: PSW
Side Effects: Command Line Buffer is modified
Special Error Conditions: None

:CRT/PRT Data   GETCRT  GETPRT  PUTCRT  PUTPRT

Z3LIB Routine: GETCRT

Function:
     Returî thå addresó oæ thå CRÔ datá recorä iî HL®   Thió 
record is structured as follows:

          crtdata:
               db   <width of the CRT in characters>
               db   <number of lines on CRT screen>
               db   <number of text lines on CRT screen>

     For example, a conventional CRT would look like:

               db   80   ; 80 cols
               db   24   ; 24 lines
               db   22   ; 22 text lines


     Thå  numbeò  oæ texô lineó shoulä bå twï lesó thaî  thå 
totaì  numbeò oæ lines®   Iô maù bå madå ³ oò ´ lesó iæ  thå 
useò wantó tï seå wideò overlağ oî hió screen®   Thå purposå 
oæ  thió recorä elemenô ió tï telì utilitieó likå  PAGÅ  ho÷ 
manù  lineó  tï outpuô beforå pausinç tï allo÷ thå  useò  tï 
reaä  thå  screen¬  anä thió caî bå reduceä (gï tï 2° oò  1¸ 
lines©  tï allo÷ thå useò tï seå morå oæ thå lasô screeî  hå 
was viewing.

Inputs: None

Outputs: HL contains the address of the CRT record

Registers Affected: HL

Side Effects: None

Special Error Conditions: None


Z3LIB Routine: GETPRT

Function:
     Returî  thå addresó oæ thå Printeò datá recorä  iî  HL®  
This record is structured as follows:

          prtdata:
               db   <width of printer in characters>
               db   <number of lines on printer page>
               db   <number of text lines on printer page>
               db   <form feed flag (0=printer can't FF)>

     For example, a typical printer data record would be:

               db   80   ; 80 columns
               db   66   ; 66 lines
               dâ   5¸   » 5¸ texô lineó (´ up/´ dî margin)
               db   1    ; printer can form feed


     Usinç  thå thirä bytå (numbeò oæ texô lineó peò  page)¬ 
thå  printeò  pagå  marginó arå selecteä aó  thå  differencå 
betweeî  thå  totaì numbeò oæ lineó anä thå numbeò  oæ  texô 
lines.
     Wheî routineó likå PRINÔ run¬  theù prinô thå numbeò oæ 
texô  lineó anä then¬  iæ thå printeò caî  forí  feed¬  theù 
issuå  á  forí feeä character®   Iæ thå printeò  can'ô  forí 
feed¬  thå  senä  ouô  thå propeò numbeò oæ blanë  lineó  tï 
advance to the next page.

Inputs: None

Outputs: HL is address of printer data buffer

Registers Affected: HL
Side Effects: None
Special Error Conditions: None


Z3LIB Routine: PUTCRT
Function:
     PUTCRÔ  storeó  thå  selectioî  (° oò  1©  iî  thå  CRÔ 
selectioî  buffeò oæ thå ZCPR³ Environmenô  Descriptor®   Aî 
erroò  codå ió returneä anä nï changå tï thå buffeò ió  madå 
if the input selection is out of range (not 0..1).

Inputs: 
     A = CRT Selection value (0 or 1)

Outputs: 
     A = Error Code
          A=0 and Zero Flag Set (Z) if invld sel (not 0 or 1)
          A=0FFH and NZ if OK

Registers Affected: PSW
Side Effects: CRT Selection flag in Env Desc is set
Special Error Conditions: None


Z3LIB Routine: PUTPRT
Function:
     PUTPRÔ  storeó  thå  selectioî  (° tï  3©  iî  thå  PRÔ 
selectioî  buffeò oæ thå ZCPR³ Environmenô  Descriptor®   Aî 
erroò  codå ió returneä anä nï changå tï thå buffeò ió  madå 
iæ thå inpuô selectioî ió ouô oæ rangå (noô 0..3).

Inputs: 
     A = PRT (Printer) Selection value (0 to 3)

Outputs: 
     A = Error Code
          A=0 and Zero Flag Set (Z) if invld sel (not 0 to 3)
          A=0FFH and NZ if OK

Registers Affected: PSW
Side Effects: PRT Selection flag in Env Desc is set
Special Error Conditions: None

:External FCB   GETEFCB

Z3LIB Routine: GETEFCB

Function:
     Returnó  thå  addresó oæ thå ZCPR³ Externaì FCÂ iî  HL®  
Returnó  witè  HL=°  anä Zerï Flaç Seô (Z© iæ  therå  ió  nï 
External FCB.

     Undeò  ZCPR3¬  á prograí caî finä ouô whaô namå iô  waó 
invokeä  bù  througè thå Externaì FCB®   Byteó  1-¸  oæ  thå 
Externaì  FCÂ  (firsô  bytå ió 0© contaiî thå  namå  oæ  thå 
program just executed by ZCPR3.

     Thió  featurå ió particularlù usefuì foò programó  likå 
Shelló  whicè  havå  tï  pusè  theiò  namå  anä  operationaì 
parameteró  ontï  thå Shelì Stacë iî ordeò tï  bå  reinvokeä 
wheî á commanä linå completes®   Á Shelì caî uså thå datá iî 
thå  Externaì  FCÂ  tï determinå whaô itó  namå  ió  withouô 
having to assume that it has a particular name at all times.


Inputs: None

Outputs: HL = address of External FCB, A=0 and Z if none

Registers Affected: HL, PSW

Side Effects: None

Special Error Conditions: None

:Environment    GETENV

Z3LIB Routine: GETENV

Function:
     Returî  thå addresó oæ thå ZCPR³ Environmenô Descriptoò 
in HL.

     Thió  functioî ió usefuì foò thoså programó whicè  neeä 
tï  modifù thå ZCPR³ Environmenô Descriptor®   Mosô  oæ  thå 
routineó iî Z3LIÂ whicè accesó thå environmenô descriptoò dï 
sï  iî  á R/Ï modå (theù dï noô allo÷ thå prograí tï  changå 
datá iî it)®   Somå programó maù neeä tï dï this¬  sï GENENÖ 
ió provided®   Z3LDR¬  foò example¬  loadó á ne÷ Environmenô 
Descriptoò froí á filå oî disk¬  anä iô useó GETENÖ tï  finä 
out where to load the file.


Inputs: None

Outputs: HL = address of Environment Descriptor

Registers Affected: HL

Side Effects: None

Special Error Conditions: None


Z3LIB Routine: GETVID

Function:
     Returî thå addresó oæ thå ZCPR³ TCAĞ (Z3TCAP© Buffeò iî 
HL.  Indicate if this buffer contains a TCAP entry.

     Thió  functioî ió usefuì foò thoså programó whicè  neeä 
tï  modifù  thå ZCPR³ TCAĞ Buffeò anä thoså  programó  whicè 
neeä  tï  determinå  iæ  thå TCAĞ  ió  loaded®   Iô  maù  bå 
desirablå  tï  calì  thió routinå beforå  á  screen-orienteä 
utilitù  ió  executeä  iî ordeò tï insurå  thaô  á  TCAĞ  ió 
available.

     Returî  witè  A=° anä Zerï Flaç Seô (Z©  iæ  nï  Z3TCAĞ 
entrù existó withiî thå buffer.


Inputs: None

Outputs: HL = address of Z3TCAP Buffer
          A=0 and Zero Flag Set (Z) if no entry in buffer

Registers Affected: HL, PSW

Side Effects: None

Special Error Conditions: None

:FCP Address    GETFCP

Z3LIB Routine: GETFCP

Function:
     Returî  thå addresó oæ thå flo÷ commanä packagå  buffeò 
iî HÌ anä thå sizå oæ thå buffeò iî termó oæ 128-bytå blockó 
in A.  If there is no FCP buffer, A=0 and Zero Flag Set (Z).

     GETFCĞ simplù returnó detailó oî thå FCĞ buffeò addresó 
anä  size¬  buô iô doeó noô saù iæ aî FCĞ ió residenô withiî 
it®   Tï  finä thió out¬  looë aô thå firsô bytå oæ thå  FCĞ 
buffer¬  and¬  iæ iô ió zero¬  theî therå ió nï FCĞ present®  
Example:
          ext  getfcp    ;reference
          ...
          call getfcp    ;obtain data
          jz   nofcpbuf  ;no FCP buffer is available
          mov  a,m       ;get first byte of buffer
          ora  a         ;set zero flag accordingly
          jz   nofcpload ;no FCP is in the buffer

Inputs: None

Outputsº HÌ ½ addresó oæ FCĞ buffer
               A=0 and Zero Flag Set (Z) if no buffer, else
               A=sizå oæ buffeò iî 128-bytå blockó anä NZ

Registers Affected: HL, PSW

Side Effects: None

Special Error Conditions: None

:Filenames      GETFN1  GETFN2  GETFNX  PUTFNX

Z3LIB Routine: GETFN1/GETFN2

Function:
     Theså  routineó returî thå addresó iî HÌ oæ  thå  shelì 
variablå  filenamå  (GETFN1© anä thå firsô filenamå  oæ  thå 
fouò  Systeí  Filå Nameó (GETFN2© iî thå  ZCPR³  Environmenô 
Descriptor®   Eacè filenamå entrù ió 1± byteó long¬ matchinç 
thå filenamå anä filetypå fieldó oæ thå CP/Í FCB.

     Theså  nameó arå useä tï pasó nameó oæ speciaì fileó tï 
programó  foò  lateò use®   Theiò exacô  definitioî  ió  noô 
presenteä  anä  lefô tï thå installer®   Onå applicatioî  oæ 
theså  ió tï allo÷ GETFN± tï returî thå namå oæ  thå  masteò 
HLĞ  filå  (HELP.HLP© whicè ió tï bå useä tï indeø intï  thå 
Help System.


Inputs: None

Outputs: HL is address of the selected file name

Registers Affected: HL

Side Effects: None

Special Error Conditions: None


Z3LIB Routine: GETFNX

Function:

     GETFNØ  returnó thå addresó oæ thå ntè filå namå iî thå 
ZCPR³ Environmenô Descriptor®   Therå arå fouò systeí files¬ 
numbereä  ±  tï 4¬  anä theù arå structureä likå  thå  FN.FÔ 
fields of an FCB (11 bytes each).

     Oî input¬ A=1..´ tï indicatå thå filå name®  Oî output¬ 
HÌ ptó tï thå firsô byte®   Á validitù checë ió donå oî  thå 
value of A (MUST be 1..4).


Inputs: 
     A = 1 to 4 (file name number)

Outputs: 
     HL = address of first byte of indicated file
     A = Error Code
          A=0 and Zero Flag Set (Z) if input was not in
               the range from 1 to 4
          A=0FFH and NZ if OK


Registers Affected: HL, PSW
Side Effects: None
Special Error Conditions: None


Z3LIB Routine: PUTFNX

Function:

     PUTFNØ  setó  thå  ntè (1..4© filå namå  iî  thå  ZCPR³ 
Environmenô  Descriptoò  tï thå FCB-entrù pointeä tï  bù  HÌ 
(FCB+1¬ oò thå FÎ field¬ ió pointeä tï bù HL)®  Á ió useä tï 
identifù thå filå name.

Inputs: 
     A = 1 to 4 (file name number)
     HL = address of FCB+1 of the new file name value

Outputs: 
     A = Error code
          A=0 and Zero Flag Set (Z) if selected file not in
               range (input A was not in 1..4)
          A=0FFH and NZ if OK


Registers Affected: PSW

Side Effects: File name is loaded

Special Error Conditions: None



:Initialize     Z3INIT

Z3LIB Routine: Z3INIT

Function:
     Obtaiî thå addresó oæ thå ZCPR³ Environmenô  Descriptoò 
froí  thå callinç prograí anä seô iô iî á globaì buffeò  foò 
future use by the Z3LIB routines.

     Z3INIT is called as follows:

          ext  z3init    ;reference
          ...
          lxi  h,z3env   ;address of ZCPR3 Environment Desc
          call z3init    ;perform function
          ...

Inputs: HL = address of ZCPR3 Environment Descriptor


Outputs: None

Registers Affected: None

Side Effects: None

Special Error Conditions: None

